<!DOCTYPE html>
<html>
<head>
    <title>API Test - NoApplAI</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 20px auto; padding: 20px; }
        button { background: #5CE1E6; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        button:hover { background: #4AC9CE; }
        pre { background: #f5f5f5; padding: 15px; border-radius: 8px; overflow-x: auto; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>NoApplAI API Test</h1>
    <button onclick="testAPI()">Test Programs API</button>
    <button onclick="checkToken()">Check Stored Token</button>
    <button onclick="testWithStoredToken()">Test with Stored Token</button>
    <pre id="output"></pre>
    
    <script>
        const API_BASE_URL = 'http://localhost:8000/api/v1';
        
        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            output.innerHTML += `<span style="color: ${color}">${message}</span>\n`;
        }
        
        function clear() {
            document.getElementById('output').innerHTML = '';
        }
        
        async function testAPI() {
            clear();
            log('=== Testing Programs API ===\n');
            
            try {
                // Login
                log('1. Attempting login...');
                const formData = new URLSearchParams();
                formData.append('username', 'demo@noapplai.com');
                formData.append('password', 'Demo123!@#');
                
                const loginResponse = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData
                });
                
                log(`   Status: ${loginResponse.status}`, loginResponse.ok ? 'success' : 'error');
                
                if (!loginResponse.ok) {
                    const error = await loginResponse.json();
                    log(`   Error: ${JSON.stringify(error, null, 2)}`, 'error');
                    return;
                }
                
                const loginData = await loginResponse.json();
                log('   ✓ Login successful!', 'success');
                log(`   Token: ${loginData.access_token.substring(0, 50)}...`);
                
                // Store token
                localStorage.setItem('access_token', loginData.access_token);
                log('   ✓ Token stored in localStorage', 'success');
                
                // Get programs
                log('\n2. Fetching programs...');
                const programsResponse = await fetch(`${API_BASE_URL}/programs/`, {
                    headers: {
                        'Authorization': `Bearer ${loginData.access_token}`
                    }
                });
                
                log(`   Status: ${programsResponse.status}`, programsResponse.ok ? 'success' : 'error');
                
                if (!programsResponse.ok) {
                    const error = await programsResponse.json();
                    log(`   Error: ${JSON.stringify(error, null, 2)}`, 'error');
                    return;
                }
                
                const programs = await programsResponse.json();
                log(`   ✓ Programs fetched successfully!`, 'success');
                log(`   Total programs: ${programs.length}`, 'success');
                
                if (programs.length > 0) {
                    log('\n3. Sample programs:');
                    programs.slice(0, 5).forEach((p, i) => {
                        log(`   ${i+1}. ${p.university_name}: ${p.program_name}`);
                        log(`      Country: ${p.country}, Degree: ${p.degree_type}`);
                    });
                    
                    log('\n4. Sample program structure:');
                    log(JSON.stringify(programs[0], null, 2));
                }
                
            } catch (error) {
                log(`\n✗ Error: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        function checkToken() {
            clear();
            const token = localStorage.getItem('access_token');
            if (token) {
                log('✓ Token found in localStorage', 'success');
                log(`Token: ${token.substring(0, 50)}...`);
            } else {
                log('✗ No token found in localStorage', 'error');
            }
        }
        
        async function testWithStoredToken() {
            clear();
            log('=== Testing with Stored Token ===\n');
            
            const token = localStorage.getItem('access_token');
            if (!token) {
                log('✗ No token found. Please run "Test Programs API" first.', 'error');
                return;
            }
            
            try {
                log('Fetching programs with stored token...');
                const response = await fetch(`${API_BASE_URL}/programs/`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                log(`Status: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    const error = await response.json();
                    log(`Error: ${JSON.stringify(error, null, 2)}`, 'error');
                    return;
                }
                
                const programs = await response.json();
                log(`✓ Success! Found ${programs.length} programs`, 'success');
                
            } catch (error) {
                log(`✗ Error: ${error.message}`, 'error');
                console.error(error);
            }
        }
    </script>
</body>
</html>
